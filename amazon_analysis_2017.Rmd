---
title: "Analysis of Amazon Stiller Task Data"
author: "Martin Fortier, Danielle Kellier, and Mike Frank"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: spacelab
    toc: yes
---

This report covers 2017 pilot data.

# Data prep

Libraries. 

```{r}
library(tidyverse)
library(stringr)
library(langcog)
library(rms)

theme_set(theme_bw())
```

Read sheets. 

```{r}
raw_data <- read_csv("data/amazon_pragmatics_data.csv")
orders <- read_csv("data/amazon_pragmatics_orders.csv")
```

Now merge in stimulus information. 

```{r}
d <- raw_data %>%
  mutate(Subid = 1:n()) %>%
  rename(Order = Orden) %>%
  gather(Trial, Choice, `Trial 1`:`Trial 10`) %>%
  mutate(Trial = as.numeric(str_sub(Trial,start = -2, -1))) %>%
  left_join(orders) %>%
  rename(TrialType = `Trial Type`) %>% 
  mutate(Correct = Choice == Target, 
         TargetStimulus = ifelse(Target == "L", L, R)) %>%
  select(Subid, Age, Order, Trial, Choice, Target, TrialType, Stimulus, TargetStimulus, Correct) 
  
```

# Primary analysis 

Now get grand means.

```{r}
mbs <- d %>%
  group_by(TrialType, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = TrialType, y = Correct)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_pointrange(col = "red", data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper)) + 
  geom_hline(lty = 2, yintercept = .5)
```

Age distribution. 

```{r}
ages <- d %>%
  group_by(Subid) %>%
  select(Age) %>%
  distinct

qplot(Age, data = ages, binwidth = 1)  
```

Check for developmental trends. First continuous.


```{r}
mbs <- d %>%
  group_by(TrialType, Age, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ggplot(mbs, aes(x = Age, y = Correct, col = TrialType)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_smooth(span = 1) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1)
```

Now discrete.

```{r}
mbs <- d %>%
  filter(!is.na(Age)) %>%
  mutate(Age_Rounded = cut(Age, 3)) %>%
  group_by(TrialType, Age_Rounded, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Age_Rounded) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Age_Rounded, y = Correct, col = TrialType)) + 
  geom_jitter(width = .05, height = .05, alpha = .3) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .2)) + 
  geom_line(data = ms, 
                  aes(y = Mean)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1)
```

# Sub analyses 

## Items 

Look at item effects. 

```{r}
mbs <- d %>%
  group_by(TrialType, Stimulus, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Stimulus) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Stimulus, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Side bias 

Look at side biase effects. Not any huge evidence of side bias, though overall test performance higher when target is on the R.

```{r}
mbs <- d %>%
  group_by(TrialType, Target, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Target) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Target, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```