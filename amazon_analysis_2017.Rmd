---
title: "Analysis of Amazon Stiller Task Data"
author: "Martin Fortier, Danielle Kellier, and Mike Frank"
date: '`r Sys.Date()`'
output:
  html_document:
    toc: yes
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: spacelab
    toc: yes
---

This report covers 2017 pilot data.

# Data prep

Libraries. 

```{r}
library(tidyverse)
library(stringr)
library(langcog)
library(rms)
library(lme4)
library(brms)
library(knitr)
library(BayesFactor)

theme_set(theme_bw())
```

Read sheets. 

```{r}
raw_data <- read_csv("data/amazon_pragmatics_data.csv")
orders <- read_csv("data/amazon_pragmatics_orders.csv")
```

Now merge in stimulus information. 

```{r}
d <- raw_data %>%
  mutate(Subid = 1:n()) %>%
  rename(Order = Orden) %>%
  gather(Trial, Choice, `Trial 1`:`Trial 10`) %>%
  mutate(Trial = as.numeric(str_sub(Trial,start = -2, -1))) %>%
  left_join(orders) %>%
  rename(TrialType = `Trial Type`) %>% 
  mutate(Correct = Choice == Target, 
         TargetStimulus = ifelse(Target == "L", L, R)) %>%
  select(Subid, Age, Order, Trial, Choice, Target, TrialType, Stimulus, TargetStimulus, Correct) %>%
  mutate(age_grp = case_when(
    Age > 4 & Age <= 6 ~ "4 - 6",
    Age > 6 & Age <= 8 ~ "6 - 8",
    Age > 8 & Age <= 10 ~ "8 - 10",
    TRUE ~ "exclude")) 
  
```



```{r}
subs <- d %>%
  group_by(Subid, age_grp) %>%
  summarise(Age = Age[1], 
            n_trials = sum(!is.na(Correct)), 
            correct = mean(Correct)) 

ggplot(subs, aes(x = Age)) + 
  geom_histogram(binwidth = .5, center = 0)
```


```{r}
subs %>%
  group_by(age_grp) %>%
  summarise(mean_age = mean(Age, na.rm=TRUE),
            sd_age = sd(Age, na.rm=TRUE),
            max_age = max(Age, na.rm=TRUE), 
            min_age = min(Age, na.rm=TRUE),
            n_trials = mean(n_trials), 
            n = n(), 
            missing_age = sum(age_grp == "exclude")) %>%
  knitr::kable()
  
```

# Primary analysis 

Now get grand means.

```{r}
mbs <- d %>%
  mutate(TrialType = forcats::fct_recode(TrialType, 
                                         `Control-Double` = "ControlDouble",
                                         `Control-Single` = "ControlSingle",
                                         `Warm-Up` = "Warm-up",
                                         `Pragmatic Inference` = "Test")) %>%
  group_by(TrialType, Age, age_grp, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, age_grp) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = TrialType, y = Correct)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_pointrange(col = "red", data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper)) + 
  geom_hline(lty = 2, yintercept = .5)
```

Check for developmental trends. First continuous.

```{r}

ggplot(mbs, aes(x = Age, y = Correct, col = TrialType)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_smooth(span = 1) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1)
```

Now discrete.

```{r}
ms <- mbs %>%
  group_by(TrialType, age_grp) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct)))) 

ggplot(filter(mbs, age_grp != "exclude"),
       aes(x = age_grp, y = Correct, col = TrialType)) + 
  # geom_jitter(width = .05, height = .05, alpha = .3) + 
  geom_pointrange(data = filter(ms, age_grp != "exclude"), 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .05)) + 
  geom_line(data = filter(ms, age_grp != "exclude"), 
                  aes(y = Mean, group = TrialType)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  ggthemes::scale_color_ptol(name = "Trial Type" ) + 
  ylab("Proportion Correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1) + 
  ggthemes::theme_few() + 
  theme(legend.position = "bottom")
```

# Stats

```{r}
d$TrialType <- forcats::fct_relevel(d$TrialType, "Test")
mod <- glmer(Correct ~ TrialType * scale(Age) + (1|Subid), 
             family = "binomial", data = filter(d, age_grp != "exclude"))
summary(mod)
```


```{r}
d$TrialType <- forcats::fct_relevel(d$TrialType, "Test")
mod <- brm(as.numeric(Correct) ~ TrialType * scale(Age) + (TrialType|Subid) + (TrialType|Stimulus), 
             family = "bernoulli", data = filter(d, age_grp != "exclude"))
summary(mod)
```

```{r}
knitr::kable(fixef(mod), digits = 2)
```
```{r}
d$TrialType <- forcats::fct_relevel(d$TrialType, "Warm-up")
mod2 <- brm(as.numeric(Correct) ~ TrialType * scale(Age) + (TrialType|Subid) + (TrialType|Stimulus), 
             family = "bernoulli", data = filter(d, age_grp != "exclude"))
knitr::kable(fixef(mod2), digits = 2)
```

## Hypothesis tests

```{r}
ttestBF(filter(mbs,TrialType=="Test")$Correct, mu = .5)
```

Just 8-10yos

```{r}
ttestBF(filter(mbs,TrialType=="Test" & age_grp == "8 - 10")$Correct, mu = .5)

```


# Sub analyses 

## Items 

Look at item effects. 

```{r}
mbs <- d %>%
  group_by(TrialType, Stimulus, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Stimulus) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Stimulus, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Side bias 

Look at side biase effects. Not any huge evidence of side bias, though overall test performance higher when target is on the R.

```{r}
mbs <- d %>%
  group_by(TrialType, Target, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Target) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Target, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                 position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```