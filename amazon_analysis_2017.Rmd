---
title: "Analysis of Amazon Stiller Task Data"
author: "Martin Fortier, Danielle Kellier, and Mike Frank"
date: '`r Sys.Date()`'
output:
html_document:
toc: yes
html_notebook:
code_folding: hide
highlight: tango
theme: spacelab
toc: yes
---

This report covers 2017 data collection.

# Data prep

Libraries. 

```{r}
library(tidyverse)
library(stringr)
library(langcog)
library(rms)
library(lme4)
library(brms)
library(knitr)
library(BayesFactor)
library(forcats)
library(ggthemes)
theme_set(theme_few())
```

Read sheets. 

```{r}
raw_data <- read_csv("data/amazon_pragmatics_data.csv")
orders <- read_csv("data/amazon_pragmatics_orders.csv")
```

Now merge in stimulus information. 

```{r}
d <- raw_data %>%
  mutate(Subid = 1:n()) %>%
  rename(Order = Orden, 
         Gender = Genero) %>%
  gather(Trial, Choice, `Trial 1`:`Trial 10`) %>%
  mutate(Trial = as.numeric(str_sub(Trial,start = -2, -1))) %>%
  left_join(orders) %>%
  rename(TrialType = `Trial Type`) %>% 
  mutate(Correct = Choice == Target, 
         TargetStimulus = ifelse(Target == "L", L, R)) %>%
  select(Subid, Age, Gender, Order, Trial, Choice, Target, TrialType, Stimulus, TargetStimulus, Correct) %>%
  mutate(age_grp = case_when(
    Age > 4 & Age <= 6 ~ "4 - 6",
    Age > 6 & Age <= 8 ~ "6 - 8",
    Age > 8 & Age <= 10 ~ "8 - 10",
    TRUE ~ "exclude"),
    TrialType = fct_recode(TrialType, 
                           `Control-Double` = "ControlDouble",
                           `Control-Single` = "ControlSingle",
                           `Warm-Up` = "Warm-up",
                           `Pragmatic Inference` = "Test"))

```



```{r}
subs <- d %>%
  group_by(Subid, age_grp) %>%
  summarise(Age = Age[1], 
            n_trials = sum(!is.na(Correct)), 
            correct = mean(Correct), 
            gender = Gender[1]) 

ggplot(subs, aes(x = Age)) + 
  geom_histogram(binwidth = .5, center = 0) 
```


```{r}
subs %>%
  group_by(age_grp) %>%
  summarise(mean_age = mean(Age, na.rm=TRUE),
            sd_age = sd(Age, na.rm=TRUE),
            max_age = max(Age, na.rm=TRUE), 
            min_age = min(Age, na.rm=TRUE),
            n_trials = mean(n_trials), 
            n = n(), 
            missing_age = sum(age_grp == "exclude"), 
            n_male = sum(gender == "M"), 
            prop_male = n_male / n) %>%
  kable(digits = 2)

```

# Primary analysis 

Now get grand means.

```{r}
mbs <- d %>%
  group_by(TrialType, Age, age_grp, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = TrialType, y = Correct, group = TrialType)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_pointrange(col = "red", data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper)) + 
  geom_hline(lty = 2, yintercept = .5)  
```

Check for developmental trends. First continuous.

```{r}
ggplot(mbs, aes(x = Age, y = Correct, col = TrialType)) + 
  geom_jitter(width = .05, height = .05) + 
  geom_smooth(span = 1, se=FALSE) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1) + 
  scale_color_ptol()
```

Now discrete.

```{r}
mbs <- d %>%
  group_by(TrialType, Age, age_grp, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, age_grp) %>%
  langcog::multi_boot_standard(col = "Correct", na.rm=TRUE)

ggplot(filter(mbs, age_grp != "exclude"),
       aes(x = age_grp, y = Correct, col = TrialType, shape = TrialType)) + 
  geom_jitter(width = .05, height = .05, alpha = .3) +
  geom_pointrange(data = filter(ms, age_grp != "exclude"), 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width = .05)) + 
  geom_line(data = filter(ms, age_grp != "exclude"), 
            aes(y = mean, group = TrialType)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_colorblind(name = "Trial Type" ) + 
  scale_shape_few(name = "Trial Type" ) + 
  ylab("Proportion Correct") + 
  xlab("Age Group (years)") + 
  ylim(0,1) + 
  theme(legend.position = "bottom")
```

Item by age analysis. 

```{r}
mbs <- d %>%
  filter(TrialType %in% c("Pragmatic Inference", "Control-Double"),
         age_grp != "exclude") %>%
  group_by(TrialType, Stimulus, age_grp, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Stimulus, age_grp) %>%
  langcog::multi_boot_standard(col = "Correct", na.rm=TRUE)

ggplot(ms, aes(x = age_grp, y = mean, col = TrialType, shape = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = mean, ymin = ci_lower, ymax = ci_upper), 
                  position = position_dodge(width = .05)) + 
  geom_line(aes(group = TrialType)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_manual(name = "Trial Type", 
                     values = c("Pragmatic Inference" = "#000000", 
                                "Control-Double" = "#E69F00")) + 
  scale_shape_manual(name = "Trial Type", 
                     values = c("Pragmatic Inference" = 1, "Control-Double" = 0)) + 
  ylab("Proportion Correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  facet_wrap(~Stimulus) + 
  theme(legend.position = "bottom")
```

# Stats

## Model

Maximal random effects structure. 

```{r}
d$TrialType <- fct_relevel(d$TrialType, "Pragmatic Inference")
bayes_mod <- brm(as.numeric(Correct) ~ TrialType * scale(Age) 
                 + (TrialType | Subid) 
                 + (TrialType * scale(Age) | Stimulus), 
                 family = "bernoulli", 
                 data = filter(d, age_grp != "exclude"))
kable(fixef(bayes_mod), digits = 2)
```

## Hypothesis tests

Control-single all kids. 

```{r}
ttestBF(filter(mbs,TrialType=="Control-Single")$Correct, mu = .5)
```

Control-single 6-8s and 8-10s:

```{r}
ttestBF(filter(mbs,TrialType=="Control-Single" & age_grp == "4 - 6")$Correct, mu = .5)
ttestBF(filter(mbs,TrialType=="Control-Single" & age_grp == "6 - 8")$Correct, mu = .5)
ttestBF(filter(mbs,TrialType=="Control-Single" & age_grp == "8 - 10")$Correct, mu = .5)
```


```{r}
ttestBF(filter(mbs, TrialType=="Pragmatic Inference")$Correct, mu = .5)
```

Just 8-10yos

```{r}
ttestBF(filter(mbs,TrialType=="Pragmatic Inference" & age_grp == "4 - 6")$Correct, mu = .5)

ttestBF(filter(mbs,TrialType=="Pragmatic Inference" & age_grp == "8 - 10")$Correct, mu = .5)

ttestBF(filter(mbs,TrialType=="Pragmatic Inference" & age_grp == "8 - 10")$Correct, mu = .5)
```

# Sub analyses 

## Items 

Look at item effects. 

```{r}
mbs <- d %>%
  group_by(TrialType, Stimulus, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Stimulus) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Stimulus, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                  position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

## Side bias 

Look at side biase effects. Not any huge evidence of side bias, though overall test performance higher when target is on the R.

```{r}
mbs <- d %>%
  group_by(TrialType, Target, Subid) %>%
  summarise(Correct = mean(Correct, na.rm=TRUE),
            n = n())

ms <- mbs %>%
  group_by(TrialType, Target) %>%
  do(data.frame(rbind(smean.cl.boot(.$Correct))))

ggplot(mbs, aes(x = Target, y = Correct, col = TrialType)) + 
  geom_pointrange(data = ms, 
                  aes(y = Mean, ymin = Lower, ymax = Upper), 
                  position = position_dodge(width = .05)) + 
  geom_hline(lty = 2, yintercept = .5) + 
  scale_color_solarized() + 
  ylab("Proportion correct") + 
  xlab("Age (years)") + 
  ylim(0,1) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


